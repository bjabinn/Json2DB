USE [TescoSubscription]
GO

SELECT *
  FROM [TescoSubscription].[tescosubscription].[UpdateRecurringPaymentIntermediate] tI

SELECT TOP 100 *
FROM [TescoSubscription].[tescosubscription].[CustomerPayment] cp
WHERE CustomerID IN (3018155734, 3018155735, 3018155677)
ORDER BY CustomerPaymentID DESC  


UPDATE tI
SET tI.CustomerPaymentId = ( SELECT TOP 1 [CustomerPaymentID]
                            FROM [TescoSubscription].[tescosubscription].[CustomerPayment] cp2
                            WHERE cp2.[CustomerID] = cp.CustomerID AND [PaymentModeID] = 1
                            ORDER BY [CustomerPaymentID] DESC), 
    tI.PreviousToken = ( SELECT TOP 1 RecurringPaymentID
                            FROM [TescoSubscription].[tescosubscription].[CustomerPayment] cp2
                            WHERE cp2.[CustomerID] = cp.CustomerID AND [PaymentModeID] = 1
                            ORDER BY [CustomerPaymentID] DESC) 
FROM [TescoSubscription].[tescosubscription].[UpdateRecurringPaymentIntermediate] tI, 
     [TescoSubscription].[tescosubscription].[CustomerPayment] cp 
WHERE tI.CustomerId = cp.CustomerID

SELECT TOP 1 *
FROM [TescoSubscription].[tescosubscription].[CustomerPayment] cp2
WHERE cp2.[CustomerID] =  3018155734 AND [PaymentModeID] = 1
ORDER BY [CustomerPaymentID] DESC

/*
DROP TABLE [TescoSubscription].[tescosubscription].[UpdateRecurringPaymentIntermediate]

CREATE TABLE [tescosubscription].[UpdateRecurringPaymentIntermediate](
	[Id] [bigint] IDENTITY(1,1) NOT NULL PRIMARY KEY,
	[CustomerPaymentId] [bigint] NOT NULL,
	[CustomerId] [bigint] NOT NULL,
	[Status] [nvarchar](50) NOT NULL,
	[Filename] [nvarchar](50) NOT NULL,
	[InsertedDate] [datetime] NOT NULL,
    [PreviousToken] [nvarchar](50), 	
	[LastUpdateDate] [datetime] NULL
) ON [PRIMARY]



UPDATE [TescoSubscription].[tescosubscription].[CustomerPayment]
SET CustomerId = 3018155734
WHERE CustomerPaymentId = 232741

UPDATE [TescoSubscription].[tescosubscription].[CustomerPayment]
SET CustomerId = 3018155734
WHERE CustomerPaymentId = 232090


UPDATE [TescoSubscription].[tescosubscription].[CustomerPayment]
SET CustomerId = 3018155735
WHERE CustomerPaymentId = 232089

UPDATE [TescoSubscription].[tescosubscription].[CustomerPayment]
SET CustomerId = 3018155677
WHERE CustomerPaymentId = 231923

DELETE 
FROM [tescosubscription].[UpdateRecurringPaymentIntermediate]
*/
